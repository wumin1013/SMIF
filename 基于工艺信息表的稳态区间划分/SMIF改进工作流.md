# SMIF稳态区间划分工具工作流

## 概述

本工作流描述基于空间加工阻抗场（SMIF）方法的稳态区间划分工具的完整操作流程。

---

## 工作流步骤

### Step 1: 数据文件准备

**输入文件：**
1. `SampleData.csv` - 采样数据文件
2. `SampleData.txt` - 程序区间交互文件

**验证：**
- 确保两个文件在同一文件夹下
- CSV文件包含5列数据（电流、vgpro功率、边缘模块功率、行号、程序号）
- TXT文件格式正确（程序名:程序号:刀具号:起始行-终止行）

---

### Step 2: 启动工具并导入数据

```
1. 运行 academic_smif_zs_v2.py
2. 点击"数据导入"区域的"浏览"按钮
3. 选择文件夹下的 SampleData.csv 和 SampleData.txt
4. 等待数据解析完成（观察进度条）
5. 确认状态栏显示"成功加载 X 个程序"
```

---

### Step 3: 选择数据源

```
1. 在"数据源选择"区域选择：
   - ○ 负载电流
   - ○ VGpro功率
   - ○ 边缘模块功率
2. 选择后图表自动更新
```

---

### Step 4: 选择程序和刀具

```
1. 从"程序选择"下拉框选择目标程序
2. 从"刀具选择"下拉框选择目标刀具
3. 图表自动显示对应数据的 P-s 曲线
```

---

### Step 5: 稳态区间划分

```
1. 设置划分参数：
   - 最小区间长度（点数）
   - 波动阈值（%）
   - 绝对波动阈值
   - 是否缩减区间边界
2. 点击"运行分析"按钮
3. 观察稳态区间高亮显示
4. 查看"稳态区间详情"文本框中的区间信息
```

> **注意：** 使用现有 `academic_smif_zs_v2.py` 的稳态区间划分算法

---

### Step 6: 实测与仿真对齐（P-s页）

```
1. 切换到"P-s对比"视图
2. 选择显示模式：
   - ○ 同图显示（叠加）
   - ○ 分图显示（上下）
3. 观察实测功率（P_meas）与仿真预测功率（P_pred）的对比
4. 查看偏差统计信息
```

---

### Step 7: 阻抗自动更新

```
1. 确保稳态区间已划分
2. 点击"更新阻抗"按钮
3. 系统自动计算：
   - 各区间的实测阻抗 Z_j = (P_j - P_idle) / MRR_j
   - 区间代表性阻抗 Z_hat = Median({Z_j})
   - 建议进给倍率调整 R_{N+1}
4. 查看阻抗更新结果面板
```

---

### Step 8: 保存结果

```
1. 点击"保存结果"按钮
2. 选择输出目录
3. 生成文件：
   - SampleData.rg：负载区间交互文件
   - 格式示例：
     0
     程序名1;1.155;18-500,600-1200;
     程序名2;1.200;50-800;
```

---

## 输出文件格式详解

### SampleData.rg

```
0                           ← 数据源标识（0=电流，1=vgpro功率，2=边缘模块功率）
OAFCAFO;1.155;18-500,600-1200;        ← 程序名;理想值（区间平均值的平均值）;区间列表
程序名2;1.200;50-800;
程序名3;0.950;100-300,400-700,800-1000;
```

**理想值计算：**
- 理想值 = 划分后所有区间平均值的平均值
- 区间平均值 = 区间内所有采样点功率的算术平均

---

## 核心公式参考

### 功率映射
$$P(s) = P_{idle} + Z(s) \cdot a_p(s) \cdot a_e(s) \cdot F(s)$$

### 阻抗反解
$$Z_j = \frac{P_j - P_{idle}}{MRR_j}$$

### 区间代表性阻抗
$$\hat{Z}_{zone} = \text{Median}\{Z_1, Z_2, \dots, Z_M\}$$

### 进给倍率更新
$$R_{i,N+1} = R_{i,N} \left(1 + \gamma \frac{\bar{P}_{pred,i} - \bar{P}_{meas,i}}{\bar{P}_{pred,i}}\right)$$

---

## 常见问题

### Q1: 导入失败怎么办？
- 检查CSV文件是否为5列格式
- 检查TXT文件是否每行以分号结尾
- 确认文件编码为UTF-8

### Q2: 区间划分结果太少/太多？
- 调整最小区间长度参数
- 调整波动阈值参数

### Q3: 阻抗更新需要哪些额外数据？
- MRR值（需要从G-code或PIT获取几何参数）
- 空载功率 P_idle
