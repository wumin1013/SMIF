# 基于SMIF双循环方法的稳态区间划分工具改进实施计划

## 背景与目标

基于论文《基于空间加工阻抗场重构与双循环时序解耦的数字孪生自进化加工方法》中提出的方法论，对现有的 `academic_smif_zs_v2.py` 脚本进行全面改进，实现：

1. **数据导入与可视化**：导入 CSV（采样数据）和 TXT（程序区间交互）文件，支持数据源选择
2. **稳态区间划分**：保留现有 `academic_smif_zs_v2.py` 的稳态区间划分方法，将 MRR 区间划分改为 P（功率）区间划分
3. **实测与仿真对齐**：在 P-s 页面按程序行号对齐实测数据和仿真预测数据
4. **阻抗自动更新**：依据论文中的阻抗反解公式自动更新阻抗系数

---

## 数据文件格式规范

### 1. 采样数据文件（SampleData.csv）
| 列序号 | 内容描述 |
|--------|----------|
| 第1列 | 电流 |
| 第2列 | vgpro功率 |
| 第3列 | 边缘模块功率 |
| 第4列 | 行号 |
| 第5列 | 程序号 |

### 2. 程序区间交互文件（SampleData.txt）
```
程序名:程序号:刀具号:起始行-终止行;
```
例如：`OAFCAFO:4080455190:T0:15-43737;`

### 3. 负载区间交互文件（SampleData.rg）- 输出格式
```
0/1/2                                              ← 数据源标识（0=电流，1=vgpro功率，2=边缘模块功率）
程序名1;理想值1;区间1起始行-区间1终止行,区间2起始行-区间2终止行;
程序名2;理想值1;区间1起始行-区间1终止行;
...
```

---

## 核心方法论（基于论文）

### 空间加工阻抗场（SMIF）功率映射

根据论文公式：
$$P(s) = P_{idle} + Z(s) \cdot MRR(s) = P_{idle} + Z(s) \cdot a_p(s) \cdot a_e(s) \cdot F(s)$$

其中：
- $P(s)$：位置 $s$ 处的切削功率
- $P_{idle}$：空载功率
- $Z(s)$：空间加工阻抗系数
- $MRR(s)$：材料去除率 = $a_p \cdot a_e \cdot F$

### 阻抗反解公式

$$Z_j = \frac{P_j - P_{idle}}{MRR_j}$$

稳态区间代表性阻抗（中值滤波）：
$$\hat{Z}_{zone} = \text{Median}\{Z_1, Z_2, \dots, Z_M\}$$

保守上界（鲁棒估计）：
$$Z_{UCB} = \hat{Z}_{zone} + \beta \cdot \sigma_Z$$

### 执行环进给倍率更新

$$R_{i,N+1} = R_{i,N} \left(1 + \gamma \frac{\bar{P}_{pred,i} - \bar{P}_{meas,i}}{\bar{P}_{pred,i}}\right)$$

---

## 功能模块设计

### 模块1：数据导入与解析

#### [MODIFY] [academic_smif_zs_v2.py](file:///d:/双循环论文写作/基于工艺信息表的稳态区间划分/academic_smif_zs_v2.py)

**改进内容：**
1. 添加 CSV 文件导入对话框，支持选择同文件夹下的 csv 和 txt 文件
2. 解析 TXT 文件获取程序映射关系
3. 解析 CSV 文件提取电流、vgpro功率、边缘模块功率三种数据源
4. 添加数据源选择控件（单选按钮组）

---

### 模块2：P-s 功率可视化与稳态区间划分

**改进内容：**
1. 将原有的 MRR-s 曲线改为 P-s（功率 vs 行程）曲线
2. **保留现有 `academic_smif_zs_v2.py` 的稳态区间划分算法**（不复用其他脚本）
3. 区间划分目标从 MRR 变为 P（功率）
4. 保留区间合并、微调等功能

---

### 模块3：实测与仿真数据对齐

**新增功能：**

在 P-s 页面添加双轴/叠加显示模式：

1. **同图显示模式**：
   - 实测功率曲线（$P_{meas}$）
   - 仿真预测功率曲线（$P_{pred}$）
   - 按程序行号对齐横坐标

2. **分图显示模式**：
   - 上图：实测功率
   - 下图：仿真预测功率
   - 横坐标统一按程序行号对齐

**对齐逻辑：**
- 仿真数据来源：通过 PIT（工艺信息表）计算 $P_{pred}(s) = P_{idle} + \hat{Z}(s) \cdot a_p(s) \cdot a_e(s) \cdot F(s)$
- 行号映射：确保实测数据点与仿真数据点按行号一一对应

---

### 模块4：阻抗自动更新

**新增功能：**

1. 基于稳态区间的阻抗反解：
   - 对每个稳态区间 $\Omega_i$，计算采样点阻抗 $Z_j = (P_j - P_{idle}) / MRR_j$
   - 鲁棒聚合：$\hat{Z}_i = \text{Median}\{Z_j\}$

2. 阻抗场更新可视化：
   - 显示每个区间的计算阻抗值
   - 对比更新前后的阻抗分布

3. 执行环倍率计算：
   - 根据公式计算下一层的进给倍率 $R_{i,N+1}$
   - 显示偏差比例 $(\bar{P}_{pred,i} - \bar{P}_{meas,i}) / \bar{P}_{pred,i}$

---

### 模块5：结果输出

**改进内容：**
1. 生成 `.rg` 负载区间交互文件
2. 输出阻抗更新后的 PIT 工艺信息表
3. 支持导出对比分析报告

---

## User Review Required

> [!IMPORTANT]
> **关键设计决策需要确认：**
> 
> 1. **MRR 数据来源**：阻抗反解需要 MRR 值，当前 CSV 文件只有功率数据。MRR 数据是否从其他文件导入，还是需要通过 G-code 解析计算？
> 
> 2. **仿真预测数据来源**：$P_{pred}$ 的计算需要 PIT 中的几何参数（$a_p, a_e$）和规划进给（$F_{plan}$），这些数据如何获取？
> 
> 3. **空载功率 $P_{idle}$**：是否作为用户输入参数，还是从数据中自动检测？

---

## Verification Plan

### 自动化测试

1. **数据导入验证**
   ```
   - 验证 CSV 解析正确性（行数、列数、数据类型）
   - 验证 TXT 程序映射解析正确性
   - 验证数据源切换功能
   ```

2. **可视化验证**
   ```
   - 验证 P-s 曲线绘制正确性
   - 验证稳态区间高亮显示
   - 验证实测/仿真双曲线对齐
   ```

3. **阻抗计算验证**
   ```
   - 对已知工况计算阻抗，与预期值对比
   - 验证中值滤波的鲁棒性
   ```

### 手动验证

1. 使用示例数据 `SampleData.csv` 和 `SampleData.txt` 进行完整流程测试
2. 检查 `.rg` 输出文件格式正确性
3. 验证阻抗更新后的重规划效果

---

## 实施步骤顺序

| 阶段 | 任务 | 依赖 |
|------|------|------|
| Phase 1 | 数据导入模块改进 | - |
| Phase 2 | P-s 可视化与稳态划分（使用现有算法） | Phase 1 |
| Phase 3 | 实测/仿真对齐显示 | Phase 2 |
| Phase 4 | 阻抗自动更新模块 | Phase 3 |
| Phase 5 | 结果输出与集成测试 | Phase 4 |
